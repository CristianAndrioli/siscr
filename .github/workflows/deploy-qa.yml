name: Deploy para QA

on:
  push:
    branches: [ develop ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  deploy-qa:
    name: Deploy para Ambiente QA
    runs-on: ubuntu-latest
    environment: qa # Requer aprovaÃ§Ã£o manual se configurado
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.QA_SSH_PRIVATE_KEY }}

      - name: Deploy para QA via SSH
        env:
          QA_HOST: ${{ secrets.QA_HOST }}
          QA_USER: ${{ secrets.QA_USER }}
        run: |
          echo "ðŸš€ Iniciando deploy para QA..."
          echo "ðŸ“¡ Conectando em $QA_HOST como $QA_USER"
          
          ssh -o StrictHostKeyChecking=no $QA_USER@$QA_HOST << 'ENDSSH'
            set -e
            echo "ðŸ“ Navegando para diretÃ³rio da aplicaÃ§Ã£o..."
            cd /opt/siscr || { echo "âŒ DiretÃ³rio /opt/siscr nÃ£o encontrado"; exit 1; }
            
            echo "ðŸ“¥ Atualizando cÃ³digo do repositÃ³rio..."
            git fetch origin
            git checkout develop
            git pull origin develop
            
            echo "ðŸ³ Parando containers..."
            docker-compose down || true
            
            echo "ðŸ—ï¸ Reconstruindo imagens..."
            docker-compose build --no-cache
            
            echo "ðŸš€ Iniciando containers..."
            docker-compose up -d
            
            echo "â³ Aguardando serviÃ§os iniciarem..."
            sleep 10
            
            echo "ðŸ”„ Executando migrations..."
            docker-compose exec -T web python manage.py migrate_schemas --shared --noinput || true
            
            echo "ðŸ“¦ Coletando arquivos estÃ¡ticos..."
            docker-compose exec -T web python manage.py collectstatic --noinput || true
            
            echo "âœ… Deploy concluÃ­do!"
            echo "ðŸ“Š Status dos containers:"
            docker-compose ps
          ENDSSH

      - name: Verificar saÃºde da aplicaÃ§Ã£o
        env:
          QA_HOST: ${{ secrets.QA_HOST }}
          QA_URL: ${{ secrets.QA_URL || 'http://qa.siscr.com.br' }}
        run: |
          echo "ðŸ¥ Verificando saÃºde da aplicaÃ§Ã£o..."
          sleep 5
          curl -f $QA_URL/api/health/ || echo "âš ï¸ Health check falhou (aplicaÃ§Ã£o pode estar iniciando)"
          echo "âœ… VerificaÃ§Ã£o concluÃ­da"

