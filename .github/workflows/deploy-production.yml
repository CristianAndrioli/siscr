name: Deploy para Produ√ß√£o

on:
  push:
    tags:
      - 'v*' # Deploy apenas com tags de vers√£o (ex: v1.0.0)
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  deploy-production:
    name: Deploy para Produ√ß√£o
    runs-on: ubuntu-latest
    environment: production # SEMPRE requer aprova√ß√£o manual
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar se √© tag de vers√£o
        if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "‚ùå Deploy para produ√ß√£o requer tag de vers√£o (ex: v1.0.0)"
          echo "üí° Use: git tag v1.0.0 && git push origin v1.0.0"
          exit 1
        continue-on-error: false

      - name: Extrair vers√£o da tag
        if: startsWith(github.ref, 'refs/tags/v')
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Vers√£o: $VERSION"

      - name: Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_PRIVATE_KEY }}

      - name: Deploy para Produ√ß√£o via SSH
        env:
          PROD_HOST: ${{ secrets.PRODUCTION_HOST }}
          PROD_USER: ${{ secrets.PRODUCTION_USER }}
          VERSION: ${{ steps.version.outputs.version || 'manual' }}
        run: |
          echo "üöÄ Iniciando deploy para PRODU√á√ÉO..."
          echo "üì¶ Vers√£o: $VERSION"
          echo "üì° Conectando em $PROD_HOST como $PROD_USER"
          
          ssh -o StrictHostKeyChecking=no $PROD_USER@$PROD_HOST << 'ENDSSH'
            set -e
            echo "üìÅ Navegando para diret√≥rio da aplica√ß√£o..."
            cd /opt/siscr || { echo "‚ùå Diret√≥rio /opt/siscr n√£o encontrado"; exit 1; }
            
            echo "üíæ Criando backup completo antes do deploy..."
            mkdir -p /opt/siscr/backups
            BACKUP_FILE="/opt/siscr/backups/pre-deploy-$(date +%Y%m%d-%H%M%S).sql"
            docker-compose exec -T db pg_dump -U postgres siscr_db > "$BACKUP_FILE" || true
            echo "‚úÖ Backup salvo em: $BACKUP_FILE"
            
            echo "üì• Atualizando c√≥digo do reposit√≥rio..."
            git fetch origin
            git checkout main
            git pull origin main
            
            echo "üê≥ Parando containers..."
            docker-compose down
            
            echo "üèóÔ∏è Reconstruindo imagens..."
            docker-compose build --no-cache
            
            echo "üöÄ Iniciando containers..."
            docker-compose up -d
            
            echo "‚è≥ Aguardando servi√ßos iniciarem..."
            sleep 20
            
            echo "üîÑ Executando migrations..."
            docker-compose exec -T web python manage.py migrate_schemas --shared --noinput || true
            
            echo "üì¶ Coletando arquivos est√°ticos..."
            docker-compose exec -T web python manage.py collectstatic --noinput || true
            
            echo "‚úÖ Deploy conclu√≠do!"
            echo "üìä Status dos containers:"
            docker-compose ps
            
            echo "üìù Vers√£o deployada: $VERSION"
          ENDSSH

      - name: Verificar sa√∫de da aplica√ß√£o
        env:
          PROD_URL: ${{ secrets.PRODUCTION_URL || 'https://siscr.com.br' }}
        run: |
          echo "üè• Verificando sa√∫de da aplica√ß√£o..."
          sleep 10
          for i in {1..5}; do
            if curl -f $PROD_URL/api/health/; then
              echo "‚úÖ Aplica√ß√£o est√° respondendo!"
              break
            else
              echo "‚è≥ Tentativa $i/5 - aguardando..."
              sleep 5
            fi
          done

      - name: Notificar sucesso
        if: success()
        run: |
          echo "‚úÖ Deploy para produ√ß√£o conclu√≠do com sucesso!"
          # Aqui voc√™ pode adicionar notifica√ß√µes (Slack, Discord, Email, etc.)

      - name: Notificar falha
        if: failure()
        run: |
          echo "‚ùå Deploy para produ√ß√£o FALHOU!"
          echo "‚ö†Ô∏è Verifique os logs e considere fazer rollback"
          # Aqui voc√™ pode adicionar alertas de falha

