name: Deploy para UAT

on:
  push:
    branches: [ staging ]
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  deploy-uat:
    name: Deploy para Ambiente UAT
    runs-on: ubuntu-latest
    environment: uat # Requer aprovaÃ§Ã£o manual se configurado
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.UAT_SSH_PRIVATE_KEY }}

      - name: Deploy para UAT via SSH
        env:
          UAT_HOST: ${{ secrets.UAT_HOST }}
          UAT_USER: ${{ secrets.UAT_USER }}
        run: |
          echo "ğŸš€ Iniciando deploy para UAT..."
          echo "ğŸ“¡ Conectando em $UAT_HOST como $UAT_USER"
          
          ssh -o StrictHostKeyChecking=no $UAT_USER@$UAT_HOST << 'ENDSSH'
            set -e
            echo "ğŸ“ Navegando para diretÃ³rio da aplicaÃ§Ã£o..."
            cd /opt/siscr || { echo "âŒ DiretÃ³rio /opt/siscr nÃ£o encontrado"; exit 1; }
            
            echo "ğŸ’¾ Criando backup antes do deploy..."
            docker-compose exec -T db pg_dump -U postgres siscr_db > /opt/siscr/backups/pre-deploy-$(date +%Y%m%d-%H%M%S).sql || true
            
            echo "ğŸ“¥ Atualizando cÃ³digo do repositÃ³rio..."
            git fetch origin
            git checkout staging
            git pull origin staging
            
            echo "ğŸ³ Parando containers..."
            docker-compose down
            
            echo "ğŸ—ï¸ Reconstruindo imagens..."
            docker-compose build --no-cache
            
            echo "ğŸš€ Iniciando containers..."
            docker-compose up -d
            
            echo "â³ Aguardando serviÃ§os iniciarem..."
            sleep 15
            
            echo "ğŸ”„ Executando migrations..."
            docker-compose exec -T web python manage.py migrate_schemas --shared --noinput || true
            
            echo "ğŸ“¦ Coletando arquivos estÃ¡ticos..."
            docker-compose exec -T web python manage.py collectstatic --noinput || true
            
            echo "âœ… Deploy concluÃ­do!"
            echo "ğŸ“Š Status dos containers:"
            docker-compose ps
          ENDSSH

      - name: Verificar saÃºde da aplicaÃ§Ã£o
        env:
          UAT_URL: ${{ secrets.UAT_URL || 'http://uat.siscr.com.br' }}
        run: |
          echo "ğŸ¥ Verificando saÃºde da aplicaÃ§Ã£o..."
          sleep 5
          curl -f $UAT_URL/api/health/ || echo "âš ï¸ Health check falhou"
          echo "âœ… VerificaÃ§Ã£o concluÃ­da"

