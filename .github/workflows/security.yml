name: VerificaÃ§Ãµes de SeguranÃ§a

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1' # Toda segunda-feira Ã  meia-noite
  workflow_dispatch:

jobs:
  security-scan:
    name: VerificaÃ§Ãµes de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Buscar Ãºltimos 2 commits para comparaÃ§Ã£o

      - name: Verificar dependÃªncias Python vulnerÃ¡veis
        run: |
          echo "ğŸ” Verificando vulnerabilidades em dependÃªncias Python..."
          pip install safety
          safety check --file requirements.txt || echo "âš ï¸ Vulnerabilidades encontradas (verificar relatÃ³rio)"

      - name: Verificar dependÃªncias Node.js vulnerÃ¡veis
        working-directory: ./frontend
        run: |
          echo "ğŸ” Verificando vulnerabilidades em dependÃªncias Node.js..."
          npm audit --audit-level=moderate || echo "âš ï¸ Vulnerabilidades encontradas (verificar relatÃ³rio)"

      - name: Verificar secrets no cÃ³digo
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          # Em PR, compara com a branch base
          # Em push direto, compara com o commit anterior (se disponÃ­vel)
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || (github.event.before != '0000000000000000000000000000000000000000' && github.event.before || github.event.repository.default_branch) }}
          head: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
          only_verified: true
        continue-on-error: true  # NÃ£o falha o workflow se nÃ£o conseguir comparar

      - name: Verificar credenciais hardcoded
        run: |
          echo "ğŸ” Verificando credenciais hardcoded..."
          # PadrÃµes comuns de credenciais
          if grep -r "password.*=.*['\"].*[a-zA-Z0-9]" --include="*.py" --include="*.js" --include="*.ts" --include="*.tsx" . | grep -v "test" | grep -v "example"; then
            echo "âš ï¸ PossÃ­veis credenciais hardcoded encontradas!"
            exit 1
          else
            echo "âœ… Nenhuma credencial hardcoded encontrada"
          fi

      - name: Verificar variÃ¡veis de ambiente sensÃ­veis
        run: |
          echo "ğŸ” Verificando uso de variÃ¡veis de ambiente..."
          # Verificar se SECRET_KEY nÃ£o estÃ¡ hardcoded
          if grep -r "SECRET_KEY.*=.*['\"].*[a-zA-Z0-9]" --include="*.py" . | grep -v "test" | grep -v "settings.py" | grep -v "example"; then
            echo "âš ï¸ SECRET_KEY pode estar hardcoded!"
            exit 1
          else
            echo "âœ… SECRET_KEY parece estar configurado corretamente"
          fi

