name: Verifica√ß√µes de Seguran√ßa

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 0 * * 1' # Toda segunda-feira √† meia-noite
  workflow_dispatch:

jobs:
  security-scan:
    name: Verifica√ß√µes de Seguran√ßa
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Buscar √∫ltimos 2 commits para compara√ß√£o

      - name: Verificar depend√™ncias Python vulner√°veis
        run: |
          echo "üîç Verificando vulnerabilidades em depend√™ncias Python..."
          pip install safety
          safety check --file requirements.txt || echo "‚ö†Ô∏è Vulnerabilidades encontradas (verificar relat√≥rio)"

      - name: Verificar depend√™ncias Node.js vulner√°veis
        working-directory: ./frontend
        run: |
          echo "üîç Verificando vulnerabilidades em depend√™ncias Node.js..."
          npm audit --audit-level=moderate || echo "‚ö†Ô∏è Vulnerabilidades encontradas (verificar relat√≥rio)"

      - name: Verificar secrets no c√≥digo
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          # Em PR, compara com a branch base
          # Em push direto, compara com o commit anterior (se dispon√≠vel)
          base: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || (github.event.before != '0000000000000000000000000000000000000000' && github.event.before || github.event.repository.default_branch) }}
          head: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
          only_verified: true
        continue-on-error: true  # N√£o falha o workflow se n√£o conseguir comparar

      - name: Verificar credenciais hardcoded
        run: |
          echo "üîç Verificando credenciais hardcoded..."
          # Verificar apenas padr√µes realmente suspeitos de credenciais hardcoded
          # Excluir: migrations, testes, node_modules, vari√°veis de c√≥digo, campos de modelo
          SUSPICIOUS=$(grep -rE "(password|api_key|secret_key|api_secret|access_token|refresh_token|bearer_token)\s*=\s*['\"][^'\"]{8,}['\"]" \
            --include="*.py" --include="*.js" --include="*.ts" --include="*.tsx" \
            --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=migrations \
            . 2>/dev/null | grep -vE "(\.get\(|\.pop\(|models\.|CharField|TextField|attrs\.|validated_data\.|request\.data\.|\.data\.get|password_confirm|password_reset|password_strength|passwordStrength|htmlFor|label|className|test|example)" || true)
          
          if [ -n "$SUSPICIOUS" ]; then
            echo "‚ö†Ô∏è Poss√≠veis credenciais hardcoded encontradas:"
            echo "$SUSPICIOUS"
            exit 1
          else
            echo "‚úÖ Nenhuma credencial hardcoded encontrada"
          fi

      - name: Verificar vari√°veis de ambiente sens√≠veis
        run: |
          echo "üîç Verificando uso de vari√°veis de ambiente..."
          # Verificar se SECRET_KEY n√£o est√° hardcoded
          if grep -r "SECRET_KEY.*=.*['\"].*[a-zA-Z0-9]" --include="*.py" . | grep -v "test" | grep -v "settings.py" | grep -v "example"; then
            echo "‚ö†Ô∏è SECRET_KEY pode estar hardcoded!"
            exit 1
          else
            echo "‚úÖ SECRET_KEY parece estar configurado corretamente"
          fi

