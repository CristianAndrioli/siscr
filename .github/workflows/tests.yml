name: Testes Unit√°rios

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  test-backend:
    name: Testes Django
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: siscr_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - Listar arquivos do projeto
        run: |
          echo "üìÅ Estrutura do projeto:"
          ls -la
          echo ""
          echo "üìÅ Conte√∫do do diret√≥rio raiz:"
          find . -maxdepth 2 -type f -name "*.py" | head -10
          echo ""
          echo "üìÅ Verificando requirements.txt:"
          if [ -f "requirements.txt" ]; then
            echo "‚úÖ requirements.txt encontrado"
            head -5 requirements.txt
          else
            echo "‚ùå requirements.txt N√ÉO encontrado"
          fi

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
        env:
          PIP_CACHE_DIR: ~/.cache/pip

      - name: Debug - Vers√µes do Python
        run: |
          echo "üêç Python version:"
          python --version
          echo ""
          echo "üì¶ pip version:"
          pip --version
          echo ""
          echo "üìÅ Python path:"
          which python

      - name: Instalar depend√™ncias do sistema
        run: |
          echo "üì¶ Atualizando pacotes do sistema..."
          sudo apt-get update
          echo "üì¶ Instalando postgresql-client e libpq-dev..."
          sudo apt-get install -y postgresql-client libpq-dev
          echo "‚úÖ Depend√™ncias do sistema instaladas"
          echo ""
          echo "üîç Verificando instala√ß√£o:"
          psql --version || echo "‚ö†Ô∏è psql n√£o encontrado no PATH"

      - name: Instalar depend√™ncias Python
        run: |
          echo "üì¶ Atualizando pip..."
          python -m pip install --upgrade pip
          echo ""
          echo "üì¶ Instalando depend√™ncias do requirements.txt..."
          echo "üìÑ Conte√∫do do requirements.txt (primeiras 10 linhas):"
          head -10 requirements.txt
          echo ""
          pip install -r requirements.txt
          echo ""
          echo "‚úÖ Depend√™ncias Python instaladas"
          echo "üì¶ Pacotes instalados:"
          pip list | head -20

      - name: Configurar vari√°veis de ambiente
        run: |
          echo "üîß Configurando vari√°veis de ambiente..."
          echo "DB_NAME=siscr_test" >> $GITHUB_ENV
          echo "DB_USER=postgres" >> $GITHUB_ENV
          echo "DB_PASSWORD=postgres" >> $GITHUB_ENV
          echo "DB_HOST=localhost" >> $GITHUB_ENV
          echo "DB_PORT=5432" >> $GITHUB_ENV
          echo "SECRET_KEY=test-secret-key-for-ci-cd" >> $GITHUB_ENV
          echo "REDIS_URL=redis://localhost:6379/1" >> $GITHUB_ENV
          echo "ENVIRONMENT=test" >> $GITHUB_ENV
          echo "CELERY_BROKER_URL=redis://localhost:6379/0" >> $GITHUB_ENV
          echo "CELERY_RESULT_BACKEND=redis://localhost:6379/0" >> $GITHUB_ENV
          echo "‚úÖ Vari√°veis de ambiente configuradas"
          echo ""
          echo "üîç Verificando conex√£o com PostgreSQL..."
          pg_isready -h localhost -p 5432 -U postgres || echo "‚ö†Ô∏è PostgreSQL ainda n√£o est√° pronto"

      - name: Executar migrations
        run: |
          echo "üîÑ Executando migrations..."
          python manage.py migrate_schemas --shared --noinput --verbosity=0 || echo "‚ö†Ô∏è Algumas migrations falharam (continuando...)"
          echo "‚úÖ Migrations conclu√≠das"

      - name: Instalar coverage
        run: |
          echo "üìä Instalando coverage..."
          pip install coverage[toml]

      - name: Executar testes com cobertura
        run: |
          echo "üß™ Executando testes unit√°rios do Django com cobertura..."
          coverage run --source='.' manage.py test --verbosity=1 --noinput
        continue-on-error: false

      - name: Gerar relat√≥rio de cobertura
        run: |
          echo "üìä Gerando relat√≥rio de cobertura..."
          echo ""
          echo "üìä Relat√≥rio geral:"
          coverage report
          echo ""
          echo "üìä Relat√≥rio detalhado por arquivo:"
          coverage report --show-missing
          echo ""
          echo "üìä Arquivos com cobertura abaixo de 70%:"
          coverage report --fail-under=70 --format=markdown > coverage_report.md || true
          if [ -f coverage_report.md ]; then
            cat coverage_report.md
          fi

      - name: Verificar cobertura m√≠nima (70%) - Aviso
        run: |
          echo "üìä Verificando cobertura m√≠nima de 70% por arquivo..."
          
          # Gerar relat√≥rio detalhado
          coverage report --show-missing > coverage_detailed.txt
          
          # Extrair cobertura total (√∫ltima linha do relat√≥rio)
          TOTAL_COVERAGE=$(coverage report | tail -n 1 | awk '{print $NF}' | sed 's/%//')
          echo "üìä Cobertura geral: ${TOTAL_COVERAGE}%"
          echo ""
          
          # Verificar arquivos com cobertura abaixo de 70%
          # Formato do coverage report: NomeArquivo    Linhas    Miss    Cover
          LOW_COVERAGE=$(coverage report | awk 'NR>3 && NF>=4 && $NF+0 < 70 && $NF+0 > 0 && $1 != "TOTAL" {print $1 " tem " $NF "% de cobertura"}')
          
          if [ -n "$LOW_COVERAGE" ]; then
            echo "‚ö†Ô∏è AVISO: Arquivos com cobertura abaixo de 70%:"
            echo "$LOW_COVERAGE"
            echo ""
            echo "‚ö†Ô∏è AVISO: Cobertura m√≠nima de 70% por arquivo n√£o atingida (n√£o falha o build)"
            echo ""
          fi
          
          # Verificar cobertura geral
          if [ -z "$TOTAL_COVERAGE" ] || [ "${TOTAL_COVERAGE%.*}" -lt 70 ]; then
            echo "‚ö†Ô∏è AVISO: Cobertura geral (${TOTAL_COVERAGE}%) est√° abaixo do m√≠nimo de 70% (n√£o falha o build)"
            echo ""
          else
            echo "‚úÖ Cobertura m√≠nima de 70% atingida (geral: ${TOTAL_COVERAGE}%)!"
            echo ""
          fi
          
          echo "üìä Relat√≥rio completo:"
          cat coverage_detailed.txt
        continue-on-error: true  # N√£o falha o build, apenas mostra aviso

  test-frontend:
    name: Testes Frontend (React)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug - Verificar estrutura do frontend
        run: |
          echo "üìÅ Estrutura do diret√≥rio frontend:"
          if [ -d "frontend" ]; then
            echo "‚úÖ Diret√≥rio frontend existe"
            ls -la frontend/ | head -20
            echo ""
            echo "üìÑ Verificando package.json:"
            if [ -f "frontend/package.json" ]; then
              echo "‚úÖ package.json encontrado"
              cat frontend/package.json | head -20
            else
              echo "‚ùå package.json N√ÉO encontrado"
            fi
            echo ""
            echo "üìÑ Verificando package-lock.json:"
            if [ -f "frontend/package-lock.json" ]; then
              echo "‚úÖ package-lock.json encontrado"
              ls -lh frontend/package-lock.json
            else
              echo "‚ùå package-lock.json N√ÉO encontrado"
              echo "‚ö†Ô∏è Tentando gerar package-lock.json..."
            fi
          else
            echo "‚ùå Diret√≥rio frontend N√ÉO existe"
            exit 1
          fi

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # Cache ser√° configurado manualmente se package-lock.json existir

      - name: Configurar cache do npm (se package-lock.json existir)
        if: hashFiles('frontend/package-lock.json') != ''
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
        continue-on-error: true # N√£o falha se o cache n√£o funcionar

      - name: Debug - Vers√µes do Node.js
        run: |
          echo "üì¶ Node.js version:"
          node --version
          echo ""
          echo "üì¶ npm version:"
          npm --version
          echo ""
          echo "üìÅ Node.js path:"
          which node

      - name: Instalar depend√™ncias
        working-directory: ./frontend
        run: |
          echo "üì¶ Instalando depend√™ncias do frontend..."
          echo "üìÑ Verificando package.json:"
          cat package.json | head -30
          echo ""
          echo "üìÑ Verificando se package-lock.json existe:"
          if [ -f "package-lock.json" ]; then
            echo "‚úÖ package-lock.json encontrado, usando npm ci (instala√ß√£o limpa)"
            npm ci
          else
            echo "‚ö†Ô∏è package-lock.json n√£o encontrado, gerando e instalando..."
            echo "üì¶ Executando npm install para gerar package-lock.json..."
            npm install
            echo ""
            echo "üí° Dica: Considere commitar o package-lock.json para builds mais r√°pidos e reproduz√≠veis"
          fi
          echo ""
          echo "‚úÖ Depend√™ncias instaladas"
          echo "üì¶ Pacotes instalados:"
          npm list --depth=0 | head -20

      - name: Executar linter
        working-directory: ./frontend
        run: |
          echo "üîç Executando linter..."
          if npm run lint 2>&1; then
            echo "‚úÖ Linter passou sem erros"
          else
            echo "‚ö†Ô∏è Linter encontrou problemas (n√£o falha o build)"
          fi

      - name: Build do frontend
        working-directory: ./frontend
        run: |
          echo "üèóÔ∏è Executando build do frontend..."
          echo "üìÑ Scripts dispon√≠veis no package.json:"
          npm run --silent 2>&1 | grep -E "^\s+\w+" || true
          echo ""
          npm run build
          echo ""
          echo "‚úÖ Build conclu√≠do"
          echo "üìÅ Conte√∫do do diret√≥rio ap√≥s build:"
          ls -la | head -20

      - name: Verificar build
        working-directory: ./frontend
        run: |
          echo "üîç Verificando resultado do build..."
          if [ -d "dist" ]; then
            echo "‚úÖ Diret√≥rio dist criado com sucesso"
            echo "üìÅ Conte√∫do do dist:"
            ls -lah dist/ | head -20
            echo ""
            echo "üìä Tamanho do build:"
            du -sh dist/
          else
            echo "‚ùå Erro: Build n√£o gerou diret√≥rio dist"
            echo "üìÅ Conte√∫do do diret√≥rio atual:"
            ls -la
            exit 1
          fi

  lint:
    name: Linting e Formata√ß√£o
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Debug - Vers√µes
        run: |
          echo "üêç Python version:"
          python --version
          echo ""
          echo "üì¶ pip version:"
          pip --version

      - name: Instalar ferramentas de lint
        run: |
          echo "üì¶ Instalando ferramentas de linting..."
          pip install flake8 black isort
          echo ""
          echo "‚úÖ Ferramentas instaladas:"
          echo "üì¶ black version:"
          black --version
          echo "üì¶ isort version:"
          isort --version
          echo "üì¶ flake8 version:"
          flake8 --version

      - name: Executar Black (formata√ß√£o)
        run: |
          echo "üé® Verificando formata√ß√£o com Black..."
          if black --check . 2>&1; then
            echo "‚úÖ Black: c√≥digo est√° formatado corretamente"
          else
            echo "‚ö†Ô∏è Black: c√≥digo precisa de formata√ß√£o (n√£o falha o build)"
          fi

      - name: Executar isort (imports)
        run: |
          echo "üì¶ Verificando ordena√ß√£o de imports com isort..."
          if isort --check-only . 2>&1; then
            echo "‚úÖ isort: imports est√£o ordenados corretamente"
          else
            echo "‚ö†Ô∏è isort: imports precisam ser ordenados (n√£o falha o build)"
          fi

      - name: Executar flake8 (linting)
        run: |
          echo "üîç Executando flake8 (erros cr√≠ticos)..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "‚ö†Ô∏è Flake8 encontrou erros cr√≠ticos (n√£o falha o build)"
          echo ""
          echo "üîç Executando flake8 (an√°lise completa)..."
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || echo "‚ö†Ô∏è Flake8 encontrou problemas (n√£o falha o build)"
          echo ""
          echo "‚úÖ Linting conclu√≠do"

